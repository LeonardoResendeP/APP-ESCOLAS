---
title: ""
lang: pt-BR
output:
  html_document:
    self_contained: true
    df_print: default
params:
  meta:
    value:
        
      nome_escola: "N/D"
      municipio: "N/D"
      data_ref: !r format(Sys.Date(), "%d/%m/%Y")
      logo_explora_uri: ""
      logo_pe_uri: ""
      logo_rabbit_uri: ""
      qr_uri: ""
      concorrentes_line: ""
      col_prim: "#147AD6"
      col_texto: "#111827"
      col_linha: "#E5E7EB"
  kpis:
    value:
      matriculas_var_total: "—"
      enem_media: "—"
      enem_delta_conc: ""
  tabelas:
    value:
      matriculas: !r data.frame()
      enem_areas: !r data.frame()
  analise:
    value:
      texto: "—"
  figuras:
    value: {}
---

```{r css_block, echo=FALSE, results='asis'}
css <- "
@page { size: A4; margin: 10mm; }
* { -webkit-print-color-adjust: exact; print-color-adjust: exact; }

/* ocupar largura total (evita 'comprimido à esquerda') */
.main-container { max-width: 100% !important; padding-left: 0; padding-right: 0; }

body { font-family: -apple-system, Segoe UI, Roboto, Arial, sans-serif; color: #111827; font-size: 11.5px; }
h1 { margin: 0 0 2px 0; color: #111827; }
h3 { margin: 6px 0 4px; color: #111827; }
small { color: #6b7280; }
hr { border: 0; border-top: 2px solid #147AD6; margin: 6px 0 6px; }

/* header em duas colunas */
.header {
  display: grid;
  grid-template-columns: 1fr 140px;
  gap: 8px;
  align-items: center;
  margin-bottom: 6px;
}
.logo-explora { max-width: 120px; height: auto; display: block; margin-left: auto; }
.sub { color: #4b5563; }

/* cartões KPI */
.kpi-wrap { display:flex; gap:8px; }
.kpi { flex:1 1 0; border:1px solid #E5E7EB; border-radius:10px; padding:8px; }
.kpi .title { font-size:10px; color:#6b7280; text-transform:uppercase; letter-spacing:.04em; }
.kpi .value { font-size:18px; font-weight:800; color:#111827; }
.kpi .delta { font-size:11px; color:#6b7280; }

/* box da análise por IA */
.card.ai p { margin: 4px 0; line-height: 1.28; }
.card.ai ul { margin: 4px 0 0 16px; padding: 0; }
.card.ai li { margin: 0 0 2px 0; }

/* rodapé com parceiros em cinza */
.footer {
  display:flex; justify-content:space-between; align-items:flex-end; margin-top:6px;
  border-top: 1px solid #E5E7EB; padding-top:6px;
}
.partner { height: 16px; filter: grayscale(100%); opacity:.9; margin-left:8px; }
/**** Concorrentes (cartão) ****/
.conc-card { 
  border:1px solid `r COL_LINE`; 
  border-radius:10px; 
  padding:8px; 
  background:#FFFFFF; 
  margin-top:8px; 
}
/**** Concorrentes + QR ****/
.conc-grid {
  display: grid;
  grid-template-columns: 1fr 120px; /* esquerda lista, direita QR */
  gap: 10px;
  align-items: start;
  margin-top: 6px;
}
.conc-card .conc-desc { margin-bottom: 4px; }
.conc-list { margin: 6px 0 0; padding-left: 18px; }
.conc-list li { margin: 2px 0; }
.conc-note { color: #6b7280; }
.qr-box {
  border: 1px dashed #E5E7EB; /* ou a sua COL_LINE */
  border-radius: 8px;
  padding: 6px;
  text-align: center;
  background: #FFF;
}
.qr-img { width: 100%; height: auto; display: block; }
"
knitr::asis_output(paste0("<style>\n", css, "\n</style>"))
```

```{r setup, include=FALSE, results='asis'}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
suppressPackageStartupMessages({
  library(knitr)
  library(kableExtra)
  library(dplyr)
  library(htmltools)
})

fmt_int  <- function(x) ifelse(is.na(x), "—", formatC(as.integer(x), format = "d", big.mark = ".", decimal.mark = ","))
fmt_num1 <- function(x) ifelse(is.na(x), "—", format(round(as.numeric(x), 1), nsmall = 1, decimal.mark = ","))

# helper p/ imagens data URI
make_img <- function(uri, class = "") {
  if (is.null(uri) || !nzchar(uri)) return("")
  sprintf('<img src="%s" class="%s" alt="logo"/>', uri, class)
}

# prepara HTML dos logos (chega pronto do builder)
logo_html      <- make_img(params$meta$logo_explora_uri, "logo-explora")
partner_pe     <- make_img(params$meta$logo_pe_uri, "partner")
partner_rabbit <- make_img(params$meta$logo_rabbit_uri, "partner")

# linha de concorrentes
conc_line <- if (!is.null(params$meta$concorrentes_line) && nzchar(params$meta$concorrentes_line)) {
  paste0("Concorrentes: ", params$meta$concorrentes_line)
} else {
  "Concorrentes: —"
}

# tokens de cor
COL_PRIM <- params$meta$col_prim
COL_TEXT <- params$meta$col_texto
COL_LINE <- params$meta$col_linha

```

```{r header_block, echo=FALSE}
library(htmltools)

# Função auxiliar para valores nulos
`%||%` <- function(a,b) if (!is.null(a) && nzchar(a)) a else b

# Prepara a linha de concorrentes
conc_line <- if (!is.null(params$meta$concorrentes_line) && nzchar(params$meta$concorrentes_line)) {
  paste0("Concorrentes: ", params$meta$concorrentes_line)
} else {
  "Concorrentes: —"
}

# Prepara a tag do logo
logo_tag <- {
  uri <- gsub("\\s+", "", params$meta$logo_explora_uri %||% "")
  if (nzchar(uri)) {
    tags$img(src = uri, class = "logo-explora", alt = "Explora")
  } else {
    ""
  }
}

# Constrói o HTML usando funções do htmltools
header_div <- div(class = "header",
  div(class = "h-left",
    h1("Relatório Executivo ",
      tags$small(style = paste0("color:", params$meta$col_prim %||% "#147AD6"), "• Explora")
    ),
    div(class = "sub",
      tags$strong("Escola:"), (params$meta$nome_escola %||% "—"), HTML("&nbsp;•&nbsp;"),
      tags$strong("Município:"), (params$meta$municipio %||% "—"), HTML("&nbsp;•&nbsp;"),
      tags$strong("Data:"), (params$meta$data_ref %||% "—")
    )
  ),
  div(class = "h-right", logo_tag)
)

# Apenas "chame" os objetos no final para renderizá-los
header_div
tags$hr()
```

### Indicadores-chave

```{r kpis, echo=FALSE}
# Carrega a biblioteca se ainda não o fez
library(htmltools)

# Operador para lidar com valores nulos (opcional, mas bom)
`%||%` <- function(a, b) if (!is.null(a)) a else b

# Cria os elementos HTML usando funções do R
kpi_div <- div(class = "kpi-wrap",
  div(class = "kpi",
    div(class = "title", "Matrículas 23→24 (var%%)"),
    div(class = "value", params$kpis$matriculas_var_total %||% "—"),
    div(class = "delta", tags$small("Base: Infantil + Fundamental + Médio"))
  ),
  div(class = "kpi",
    div(class = "title", "ENEM (média geral)"),
    div(class = "value", params$kpis$enem_media %||% "—"),
    div(class = "delta",
      if (!is.null(params$kpis$enem_delta_conc) && nzchar(params$kpis$enem_delta_conc)) {
        tags$small(sprintf("Δ vs conc.: %s", params$kpis$enem_delta_conc))
      } else {
        ""
      }
    )
  )
)

# Apenas chame o objeto no final do chunk. O knitr o renderizará automaticamente.
kpi_div
```

```{r concorrentes_qr, echo=FALSE}
library(htmltools)

`%||%` <- function(a,b) if (!is.null(a) && nzchar(a)) a else b

# 1) Lista de concorrentes (pega a string e quebra em itens)
raw <- params$meta$concorrentes_line %||% ""
items <- character(0)
if (nzchar(raw)) {
  items <- strsplit(raw, ",\\s*")[[1]]
  items <- items[nzchar(items)]
  items <- head(items, 5)  # máximo 5
}

lis_tag <- if (length(items)) {
  tags$ul(class = "conc-list",
    lapply(items, function(x) {
      m <- regexec("^(.*)\\s*\\(([^)]+)\\)\\s*$", x)
      ma <- regmatches(x, m)[[1]]
      if (length(ma) == 3) {
        tags$li(tagList(
          htmlEscape(ma[2]),
          tags$small(class="muted", paste0(" (ID ", htmlEscape(ma[3]), ")"))
        ))
      } else {
        tags$li(htmlEscape(x))
      }
    })
  )
} else {
  NULL
}

left_col <- div(class = "conc-card",
  div(class = "conc-desc",
      tags$strong("Concorrentes próximos"), tags$br(),
      tags$small("Estes são os 5 concorrentes mais próximos identificados.")
  ),
  if (!is.null(lis_tag)) lis_tag else div(class="conc-note", tags$small("Nenhum concorrente selecionado.")),
  div(class = "conc-note", style="margin-top:6px;",
      tags$small("Você pode editar os concorrentes no app.")
  )
)

# 2) QR à direita — mesma lógica do header: um <img> com src=data:...
qr_uri <- gsub("\\s+", "", params$meta$qr_uri %||% "")
right_col <- if (nzchar(qr_uri)) {
  div(class = "qr-box",
      tags$img(src = qr_uri, class = "qr-img", alt = "QR para o app"),
      tags$small("Aponte a câmera para acessar o app")
  )
} else {
  NULL
}

# 3) Renderiza o grid (se o QR faltar, fica 1 coluna automaticamente)
div(class = "conc-grid",
  left_col,
  right_col
)
```

### Matrículas por segmento (23→24)

```{r}
df <- params$tabelas$matriculas
if (is.data.frame(df) && nrow(df) > 0) {
  # garante nomes
  colnames(df) <- c("Segmento","2023","2024","Var% Esc.","Var% Conc.","Var% Mun.")
  df$`2023` <- fmt_int(df$`2023`); df$`2024` <- fmt_int(df$`2024`)
  
  df |>
    kableExtra::kbl(align = c("l","r","r","r","r","r"), escape = TRUE) |>
    kableExtra::kable_classic(full_width = TRUE, html_font = "Segoe UI") |>
    kableExtra::kable_styling(bootstrap_options = c("condensed"), full_width = TRUE) |>
    kableExtra::row_spec(0, extra_css = sprintf("background:#F7FAFF;color:%s;", COL_TEXT)) |>
    kableExtra::add_header_above(c(" " = 1, "Valores" = 2, "Variações (%%)" = 3))
} else {
  cat("*Sem dados de matrículas por segmento.*")
}

```

### ENEM por área (média)

```{r enem_por_area, echo=FALSE, results='asis'}
ea <- params$tabelas$enem_areas

if (is.data.frame(ea) && nrow(ea) > 0) {
  # ordem canônica de exibição
  ordem <- c("Linguagens e Códigos","Matemática","Ciências Humanas","Ciências da Natureza","Redação")
  if ("Área" %in% names(ea)) {
    ea$Área <- factor(ea$Área, levels = ordem)
    ea <- ea[order(ea$Área), , drop = FALSE]
    ea$Área <- as.character(ea$Área)
  }

  # Garante as 3 colunas esperadas; se alguma faltar, cria vazia
  faltantes <- setdiff(c("Sua Escola","Média Concorrentes","Média Municipal"), names(ea))
  for (m in faltantes) ea[[m]] <- NA_real_

  # Formatação numérica (1 casa, vírgula como separador decimal)
  for (cc in c("Sua Escola","Média Concorrentes","Média Municipal")) {
    ea[[cc]] <- fmt_num1(ea[[cc]])
  }

  # Render com kableExtra
  ea |>
    kableExtra::kbl(
      align = c("l","r","r","r"),
      col.names = c("Área","Sua Escola","Média Concorrentes","Média Municipal"),
      escape = TRUE
    ) |>
    kableExtra::kable_classic(full_width = TRUE, html_font = "Segoe UI") |>
    kableExtra::kable_styling(bootstrap_options = c("condensed"), full_width = TRUE) |>
    kableExtra::row_spec(0, extra_css = "background:#F7FAFF;")
} else {
  cat("*Sem dados do ENEM por área.*")
}
```

### Análise executiva

```{r analise_exec, echo=FALSE, results='asis'}
library(htmltools)

`%||%` <- function(a, b) if (!is.null(a)) a else b

# Remove cercas de código Markdown, ex.: ```html ... ```
strip_md_fences <- function(s) {
  s <- sub("^\\s*```[a-zA-Z]*\\s*\\n?", "", s)  # tira início ``` ou ```html
  s <- sub("\\n?\\s*```\\s*$", "", s)           # tira final ```
  s
}

txt <- params$analise$texto %||% ""

if (nzchar(txt)) {
  txt <- strip_md_fences(txt)

  # Se NÃO houver tags HTML conhecidas, converte \n -> <br/> (texto puro).
  # Se já vier com <p>, <ul>, <li>... mantém como está.
  if (!grepl("<(p|ul|ol|li|br|strong|em)\\b", txt, ignore.case = TRUE)) {
    txt <- gsub("\n", "<br/>", txt, fixed = TRUE)
  }

  div(class = "card ai", HTML(txt))
} else {
  tags$em("Sem análise gerada.")
}
```

```{r footer_open, echo=FALSE, results='asis'}
knitr::asis_output('<div class="footer"><div class="left"><small>Dados: Censo Escolar 2023–2024 • ENEM 2024 • Concorrentes = selecionados</small></div><div class="right" style="display:flex;align-items:center;">')
```

```{r}
partner_html <- paste0(
  if (!is.null(params$meta$logo_pe_uri)     && nzchar(params$meta$logo_pe_uri))     sprintf('<img class="partner" src="%s" alt="Primeira Escolha"/>', params$meta$logo_pe_uri) else "",
  if (!is.null(params$meta$logo_rabbit_uri) && nzchar(params$meta$logo_rabbit_uri)) sprintf('<img class="partner" src="%s" alt="Rabbit"/>',            params$meta$logo_rabbit_uri) else ""
)
knitr::asis_output(partner_html)
```

```{rfooter_close, echo=FALSE, results='asis'}
knitr::asis_output('</div></div>')
```
